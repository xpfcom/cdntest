<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>iTxGo🍃 - 智能路由</title>
<style>
  body {
    margin: 0;
    background: #f3f4f6;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
  .segments {
    display: flex;
    gap: 10px;
    transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.6s linear 0.1s, filter 0.6s ease;
    margin-bottom: 20px;
  }
  .segments.fade-out {
    transform: scale(1.8);
    opacity: 0;
    filter: blur(8px);
  }
  .segment {
    width: 28px;
    height: 16px;
    border-radius: 4px;
    animation: light 1s infinite ease-in-out;
  }
  .segment:nth-child(1) { background: #6366f1; animation-delay: 0s; }
  .segment:nth-child(2) { background: #ec4899; animation-delay: 0.2s; }
  .segment:nth-child(3) { background: #0ea5e9; animation-delay: 0.4s; }
  .segment:nth-child(4) { background: #10b981; animation-delay: 0.6s; }
  .segment:nth-child(5) { background: #f59e0b; animation-delay: 0.8s; }

  @keyframes light {
    0%,100% { opacity: 0.4; }
    50% { opacity: 1; }
  }
  
  .status {
    color: #64748b;
    margin-top: 20px;
    text-align: center;
    max-width: 80%;
    line-height: 1.5;
    font-size: 14px;
  }
  
  .status.error { color: #ef4444; }
  
  .results {
    margin-top: 10px;
    font-size: 12px;
    color: #94a3b8;
    text-align: center;
  }
  
  .retry-btn {
    margin-top: 20px;
    padding: 8px 16px;
    background: #e2e8f0;
    border: none;
    border-radius: 6px;
    color: #334155;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 14px;
    display: none;
  }
  
  .retry-btn:hover { background: #cbd5e1; }
</style>
</head>
<body>
<div class="segments" id="loader">
  <div class="segment"></div>
  <div class="segment"></div>
  <div class="segment"></div>
  <div class="segment"></div>
  <div class="segment"></div>
</div>

<div class="status" id="status">正在检测最优服务器...</div>
<div class="results" id="results"></div>
<button class="retry-btn" id="retryBtn">重新检测</button>

<script>
const SERVERS = [
  { url: 'https://itxgo.com', name: 'CloudFlare' },
  { url: 'https://wllgo.com', name: 'Vercel' },
  { url: 'https://381661.xyz', name: 'Netlify' }
];

const elements = {
  loader: document.getElementById('loader'),
  status: document.getElementById('status'),
  results: document.getElementById('results'),
  retryBtn: document.getElementById('retryBtn')
};

let isDetecting = false;

// 测试服务器
async function testServer(server) {
  const start = performance.now();
  
  return new Promise((resolve) => {
    const img = new Image();
    const timer = setTimeout(() => resolve({ ...server, ok: false, time: Infinity }), 3000);
    
    const finish = (ok) => {
      clearTimeout(timer);
      const time = performance.now() - start;
      console.log(`${server.name}: ${ok ? '成功' : '失败'} ${time.toFixed(0)}ms`);
      resolve({ ...server, ok, time });
    };
    
    img.onload = () => finish(true);
    img.onerror = () => finish(true); // 404也算可达
    img.src = `${server.url}/favicon.ico?t=${Date.now()}&r=${Math.random()}`;
  });
}

// 更新界面
function updateUI(status, results = '', isError = false) {
  elements.status.textContent = status;
  elements.status.className = isError ? 'status error' : 'status';
  elements.results.textContent = results;
}

// 主检测函数
async function detect() {
  if (isDetecting) return;
  
  isDetecting = true;
  elements.retryBtn.style.display = 'none';
  elements.loader.classList.remove('fade-out');
  updateUI('正在检测最优服务器...');
  
  try {
    console.log('开始检测...');
    const results = await Promise.all(SERVERS.map(testServer));
    console.table(results);
    
    const available = results.filter(r => r.ok);
    if (available.length === 0) {
      throw new Error('所有服务器均不可用');
    }
    
    available.sort((a, b) => a.time - b.time);
    const best = available[0];
    
    const resultText = available.slice(0, 3).map(r => `${r.name}: ${r.time.toFixed(0)}ms`).join(' | ');
    updateUI(`最优服务器: ${best.name} (${best.time.toFixed(0)}ms)`, resultText);
    
    console.log('跳转到:', best.url);
    elements.loader.classList.add('fade-out');
    setTimeout(() => window.location.href = best.url, 700);
    
  } catch (error) {
    console.error('检测失败:', error);
    updateUI(error.message, '', true);
    elements.retryBtn.style.display = 'block';
  } finally {
    isDetecting = false;
  }
}

// 初始化
elements.retryBtn.onclick = detect;
detect();
</script>
</body>
</html>
