<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>iTxGoğŸƒ - æ™ºèƒ½è·¯ç”±</title>
<style>
  body {
    margin: 0;
    background: #f3f4f6;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
  .segments {
    display: flex;
    gap: 10px;
    transform: scale(1);
    transition: 
      transform 0.6s cubic-bezier(0.22, 1, 0.36, 1),
      opacity 0.6s linear 0.1s,
      filter 0.6s ease;
    margin-bottom: 20px;
  }
  .segments.fade-out {
    transform: scale(1.8);
    opacity: 0;
    filter: blur(8px);
  }
  .segment {
    width: 28px;
    height: 16px;
    border-radius: 4px;
    animation: light 1s infinite ease-in-out;
  }
  .segment:nth-child(1) { background: #6366f1; animation-delay: 0s; }
  .segment:nth-child(2) { background: #ec4899; animation-delay: 0.2s; }
  .segment:nth-child(3) { background: #0ea5e9; animation-delay: 0.4s; }
  .segment:nth-child(4) { background: #10b981; animation-delay: 0.6s; }
  .segment:nth-child(5) { background: #f59e0b; animation-delay: 0.8s; }

  @keyframes light {
    0%,100% { opacity: 0.4; }
    50% { opacity: 1; }
  }
  
  .status {
    color: #64748b;
    margin-top: 20px;
    text-align: center;
    max-width: 80%;
    line-height: 1.5;
    font-size: 14px;
  }
  
  .retry-btn {
    margin-top: 20px;
    padding: 8px 16px;
    background: #e2e8f0;
    border: none;
    border-radius: 6px;
    color: #334155;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 14px;
  }
  
  .retry-btn:hover {
    background: #cbd5e1;
  }
  
  .retry-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .results {
    margin-top: 15px;
    font-size: 12px;
    color: #94a3b8;
    text-align: center;
    max-width: 300px;
  }
  
  .offline {
    color: #ef4444;
  }

  @media (max-width: 480px) {
    .segments {
      gap: 8px;
    }
    .segment {
      width: 24px;
      height: 14px;
    }
    .status {
      font-size: 13px;
      max-width: 90%;
    }
  }
</style>
</head>
<body>
<div class="segments" id="loader">
  <div class="segment"></div>
  <div class="segment"></div>
  <div class="segment"></div>
  <div class="segment"></div>
  <div class="segment"></div>
</div>

<div class="status" id="status">æ­£åœ¨æ£€æµ‹æœ€ä¼˜æœåŠ¡å™¨...</div>
<div class="results" id="results"></div>
<button class="retry-btn" id="retryBtn" style="display: none;">é‡æ–°æ£€æµ‹</button>

<script>
const SERVERS = [
  { url: 'https://itxgo.com', name: 'CloudFlare' },
  { url: 'https://wllgo.com', name: 'Vercel' },
  { url: 'https://381661.xyz', name: 'Netlify' }
];

const CONFIG = {
  timeout: 3000
};

let isDetecting = false;

// æµ‹è¯•å•ä¸ªæœåŠ¡å™¨
async function testServer(server) {
  const start = performance.now();
  
  try {
    console.log(`æ­£åœ¨æµ‹è¯• ${server.name}...`);
    
    // ä½¿ç”¨éšæœºå‚æ•°ç¡®ä¿ä¸ä¼šè¢«ç¼“å­˜
    const randomParam = Math.random().toString(36).substring(7);
    const timestamp = Date.now();
    const testUrl = `${server.url}/favicon.ico?nocache=${timestamp}&rand=${randomParam}`;
    
    const img = new Image();
    
    const result = await new Promise((resolve, reject) => {
      const timer = setTimeout(() => {
        reject(new Error('timeout'));
      }, CONFIG.timeout);
      
      img.onload = () => {
        clearTimeout(timer);
        const time = performance.now() - start;
        console.log(`${server.name} æˆåŠŸ: ${time.toFixed(0)}ms`);
        resolve({ ...server, ok: true, time });
      };
      
      img.onerror = () => {
        clearTimeout(timer);
        // å³ä½¿å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä¹Ÿè¯´æ˜æœåŠ¡å™¨æ˜¯å¯è¾¾çš„
        const time = performance.now() - start;
        console.log(`${server.name} å¯è¾¾ (å›¾ç‰‡å¤±è´¥): ${time.toFixed(0)}ms`);
        resolve({ ...server, ok: true, time });
      };
      
      // ç¡®ä¿ä¸ä½¿ç”¨ç¼“å­˜
      img.src = testUrl;
    });
    
    return result;
  } catch (error) {
    console.log(`${server.name} å¤±è´¥: ${error.message}`);
    return { ...server, ok: false, time: Infinity };
  }
}

// æ›´æ–°çŠ¶æ€
function updateStatus(text, isError = false) {
  const statusEl = document.getElementById('status');
  statusEl.textContent = text;
  statusEl.className = isError ? 'status offline' : 'status';
}

// æ˜¾ç¤ºç»“æœ
function showResults(results) {
  const resultsEl = document.getElementById('results');
  const available = results.filter(r => r.ok).sort((a, b) => a.time - b.time);
  
  if (available.length > 0) {
    const summary = available.slice(0, 3).map(r => 
      `${r.name}: ${r.time.toFixed(0)}ms`
    ).join(' | ');
    resultsEl.textContent = summary;
  } else {
    resultsEl.textContent = 'æ‰€æœ‰æœåŠ¡å™¨å‡ä¸å¯ç”¨';
  }
}

// ä¸»æ£€æµ‹å‡½æ•°
async function runDetection() {
  if (isDetecting) return;
  
  const loader = document.getElementById('loader');
  const retryBtn = document.getElementById('retryBtn');
  const resultsEl = document.getElementById('results');
  
  try {
    isDetecting = true;
    retryBtn.style.display = 'none';
    retryBtn.disabled = true;
    loader.classList.remove('fade-out');
    resultsEl.textContent = '';
    updateStatus('æ­£åœ¨æ£€æµ‹æœ€ä¼˜æœåŠ¡å™¨...');
    
    console.log('å¼€å§‹æœåŠ¡å™¨æµ‹é€Ÿ...');
    
    // å¹¶å‘æµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨
    const results = await Promise.all(SERVERS.map(testServer));
    
    console.table(results);
    
    // ç­›é€‰å¯ç”¨æœåŠ¡å™¨
    const available = results.filter(r => r.ok);
    
    if (available.length === 0) {
      throw new Error('æ‰€æœ‰æœåŠ¡å™¨å‡ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    }
    
    // æŒ‰å»¶è¿Ÿæ’åº
    available.sort((a, b) => a.time - b.time);
    const best = available[0];
    
    updateStatus(`æ£€æµ‹å®Œæˆï¼Œæœ€ä¼˜æœåŠ¡å™¨: ${best.name} (${best.time.toFixed(0)}ms)`);
    showResults(results);
    
    console.log(`é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨: ${best.name}, å»¶è¿Ÿ: ${best.time.toFixed(0)}ms`);
    console.log('å³å°†è·³è½¬åˆ°:', best.url);
    
    // æ‰§è¡Œè·³è½¬
    loader.classList.add('fade-out');
    
    setTimeout(() => {
      console.log('æ­£åœ¨è·³è½¬...');
      window.location.href = best.url;
    }, 700);
    
  } catch (error) {
    console.error('æ£€æµ‹å¤±è´¥:', error);
    updateStatus(error.message, true);
    retryBtn.style.display = 'block';
  } finally {
    isDetecting = false;
    retryBtn.disabled = false;
  }
}

// ç½‘ç»œçŠ¶æ€ç›‘å¬
window.addEventListener('online', () => {
  updateStatus('ç½‘ç»œå·²æ¢å¤ï¼Œæ­£åœ¨é‡æ–°æ£€æµ‹...');
  setTimeout(runDetection, 1000);
});

window.addEventListener('offline', () => {
  updateStatus('ç½‘ç»œè¿æ¥å·²æ–­å¼€', true);
});

// åˆå§‹åŒ–
document.getElementById('retryBtn').addEventListener('click', runDetection);

// å¼€å§‹æ£€æµ‹
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', runDetection);
} else {
  runDetection();
}
</script>
</body>
</html>
